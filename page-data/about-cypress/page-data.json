{"componentChunkName":"component---src-templates-blog-post-js","path":"/about-cypress/","result":{"data":{"site":{"siteMetadata":{"title":"MINJI'S PLAYGROUND"}},"markdownRemark":{"id":"74e9c19f-a40d-5ff7-abf3-07ce11458ade","excerpt":"Cypress 사용자 입장에서 서비스를 테스트 하고 싶을때 뿐만 아니라 가장 적합한 테스트 도구이다. \n우리 회사는 QA 인원이 한정적이기 때문에 반복적인 QA 작업은 점진적으로 Cypress 를 도입하고 있다. CI/CD 에 테스트를 넣어서도 진행할 수 있지만\nAI…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e0a07256bb75e4ed2ce36c0cb04c33d9/94774/image.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.9620253164557%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABi0lEQVQoz11STW8TMRDNfyLNHyg/pJwr/kK5AjfgUqS2ogf6Byq4tqGkHDhQrimQ9NBsRdTsesb2fHi7RvZmk1DryfK80bM0b16vMgatM4ArACKgBexK2HwseUBrnesBoISaRT2xI3aeWFQ0sARWZXmMtkWsLKFnAFiUWJqmifloqJ0nT+KIff6uhc+lJyYWYmHRXlkZloDWjUbfvo4uh18ubmcz0eCJagnMqqEmUcl3KyPqxJUxD038M70ZDAY7O8/6T7Y+HB/HGI2la4TSQlEUBqC4uwNA58k650k8i2gnvv71e2/vxenppzdv3308OYkxzgtzMfz8/efZq5evj44O99/vX139GI/Hk8mEOImZkxiaGKfTm35/a3f3+fb204ODwxgjgn1Y3FvE+0X5dz4vywqsXZSVdW49swFQrdH50WWa+ex8eDsrREJyXpeurhwmVp/QiQHwkduiIfssrbft/lZWp9ZajFmc97wEC2Xm/912pa7JNLN1HtC2GUrZ2kjbJrlEThimhPl/3GteDtl/Xm4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"alt text\"\n        title=\"alt text\"\n        src=\"/static/e0a07256bb75e4ed2ce36c0cb04c33d9/f058b/image.png\"\n        srcset=\"/static/e0a07256bb75e4ed2ce36c0cb04c33d9/c26ae/image.png 158w,\n/static/e0a07256bb75e4ed2ce36c0cb04c33d9/6bdcf/image.png 315w,\n/static/e0a07256bb75e4ed2ce36c0cb04c33d9/f058b/image.png 630w,\n/static/e0a07256bb75e4ed2ce36c0cb04c33d9/40601/image.png 945w,\n/static/e0a07256bb75e4ed2ce36c0cb04c33d9/78612/image.png 1260w,\n/static/e0a07256bb75e4ed2ce36c0cb04c33d9/94774/image.png 3074w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h5>Cypress</h5>\n<p>사용자 입장에서 서비스를 테스트 하고 싶을때 뿐만 아니라 가장 적합한 테스트 도구이다. <br/>\n우리 회사는 QA 인원이 한정적이기 때문에 <br/>반복적인 QA 작업은 점진적으로 Cypress 를 도입하고 있다.<br/></p>\n<p>CI/CD 에 테스트를 넣어서도 진행할 수 있지만<br/>\nAI 챗봇 서비스에서 일부 신규상장건 및 사명변경이 된 종목들은 화면에서 종목명과<br/>\n답변의 종목명이 다르게 보이는 이슈가 있었다.</p>\n<p>이는 백엔드 측에서 매일 아침 서비스에 들어가 일일히 신규상장건을 확인한다는 제보를 받았다.<br/>\n물론 국내쪽만 확인하는 터라 그렇게 많지는 않은 갯수였지만<br/> 이 또한 여러모로 리소스가 드는 일이다.<br/></p>\n<h4>구현하고 싶은 사항</h4>\n<ol>\n<li>그날 이슈가 있는 종목을 리스트로 받아 매일 아침 8시 40분에 <br/>종목별로 사명이 맞게 들어가는지 테스트를 한다.</li>\n<li>해당 종목의 테스트 결과를 SLCAK 채널로 전송한다.</li>\n<li>단순히 테스트 실패 여부를 보내기 보다는 어떤 종목에서 이슈가 생겼는지 실패한 스크린샷을 보낸다.</li>\n</ol>\n<h4>테스트 코드 작성하기</h4>\n<p>우선 구현하고자 하는 테스트 코드를 작성한다.<br/>\n신규상장건들은 굳이 DB를 치지 않아도 될 일이라<br/>\n매일 데이터팀에서 S3로 올려준 파일을 활용하여 받기로 하였다.<br/></p>\n<p>ex) spec.cy.ts (샘플코드)</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'template spec'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'AI CHAT E2E TEST'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    신규상장건들<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">종목</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      cy<span class=\"token punctuation\">.</span><span class=\"token function\">visit</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">URL</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">?symbol=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>종목<span class=\"token punctuation\">.</span>symbol<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&amp;cmp_nm=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">encodeURIComponent</span><span class=\"token punctuation\">(</span>종목<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      cy<span class=\"token punctuation\">.</span><span class=\"token function\">wait</span><span class=\"token punctuation\">(</span><span class=\"token number\">7000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      cy<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span>종목<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">should</span><span class=\"token punctuation\">(</span><span class=\"token string\">'be.visible'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h4>테스트 결과와 실패스크린샷 슬랙에 전송하기</h4>\n<ul>\n<li>cypress test 하기</li>\n<li>결과 여부 테스트 slack 채널에 전송하기</li>\n<li>실패하면 어느 부분에서 실패했는지 스크린샷도 같이 보내기</li>\n<li>이 모든 동작은 셸스크립트 파일로 자동화한다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">#!/bin/bash\n\n#테스트 환경세팅, 실행\necho &quot;E2E 테스트 시작&quot;\n\nexport NVM_DIR=&quot;$HOME/.nvm&quot;\n[ -s &quot;$NVM_DIR/nvm.sh&quot; ] &amp;&amp; \\. &quot;$NVM_DIR/nvm.sh&quot;\n\nnvm use 20.5.1\n\nexport PATH=$NVM_DIR/versions/node/v20.5.1/bin:$PATH\n\ncd /Users/alpahbridge/code/alpha/tangopick_provider\n\nyarn cypress:run &gt; cypress.log 2&gt;&amp;1\n\n# Cypress 로그 읽기 =&gt; 테스트 결과로 로그를 떨어트려 준다.\nLOG_CONTENT=$(awk &#39;/\\(Run Finished\\)/,0&#39; cypress.log | jq -R -s &#39;.&#39;)\n</code></pre></div>\n<p>테스트 환경을 세팅해주고 테스트실행, <br/>결과를 읽어 LOG_CONTENT라는 변수에 할당한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">\ncomplete_upload_external() {\n  local file_path=&quot;$1&quot;\n  local file_name=$(basename &quot;$file_path&quot;)\n  local file_size=$(stat -f%z &quot;$file_path&quot;)\n\n  # 업로드 URL 요청🔥\n  local getupload_payload=&quot;filename=$(urlencode &quot;$file_name&quot;)&amp;length=$file_size&amp;channels=$(urlencode &quot;$SLACK_CHANNEL_ID&quot;)&quot;\n\n  local start_response=$(curl -s -X POST \\\n    -H &quot;Authorization: Bearer $SLACK_TOKEN&quot; \\\n    -H &quot;Content-Type: application/x-www-form-urlencoded&quot; \\\n    --data &quot;$getupload_payload&quot; \\\n    https://slack.com/api/files.getUploadURLExternal)\n\n  local upload_url=$(echo &quot;$start_response&quot; | jq -r &#39;.upload_url&#39;)\n  local file_id=$(echo &quot;$start_response&quot; | jq -r &#39;.file_id&#39;)\n\n  if [ &quot;$upload_url&quot; = &quot;null&quot; ] || [ &quot;$file_id&quot; = &quot;null&quot; ]; then\n\n    echo &quot;업로드 url 얻기 실패: $start_response&quot;\n    return\n  fi\n\n  # 파일 업로드\n  local upload_response=$(curl -s -F file=@&quot;$file_path&quot; &quot;$upload_url&quot;)\n  echo &quot;파일 업로드 응답값: $upload_response&quot;\n\n  # 업로드 완료 요청🔥\n  local complete_payload=$(jq -n --arg file_id &quot;$file_id&quot; &#39;{\n    file_id: $file_id,\n    files: [{ id: $file_id }]\n  }&#39;)\n  echo &quot;$complete_payload&quot; &gt; /tmp/complete_payload.json\n\n  local complete_response=$(curl -s -X POST \\\n    -H &quot;Authorization: Bearer $SLACK_TOKEN&quot; \\\n    -H &quot;Content-Type: application/json&quot; \\\n    -d @/tmp/complete_payload.json \\\n    https://slack.com/api/files.completeUploadExternal)\n\n  echo &quot;파일 업로드 요청 응답값: $complete_response&quot;\n\n  # 파일 공유 요청🔥\n local share_payload=&quot;file=$(urlencode &quot;$file_id&quot;)&amp;channels=$(urlencode &quot;$SLACK_CHANNEL_ID&quot;)&quot;\n\n  echo &quot;$share_payload&quot; &gt; /tmp/share_payload.json\n\n  local share_response=$(curl -s -X POST \\\n    -H &quot;Authorization: Bearer $SLACK_TOKEN&quot; \\\n    -H &quot;Content-Type: application/x-www-form-urlencoded&quot; \\\n    -d @/tmp/share_payload.json \\\n    https://slack.com/api/files.remote.share)\n\n  echo &quot;공유 응답값: $share_response&quot;\n\n}\n\n# URL 인코딩 함수\nurlencode() {\n  local string=&quot;$1&quot;\n  local encoded=&quot;&quot;\n  for (( i=0; i&lt;${#string}; i++ )); do\n    local char=&quot;${string:$i:1}&quot;\n    case &quot;$char&quot; in\n      [a-zA-Z0-9.~_-]) encoded+=&quot;$char&quot; ;;\n      *) encoded+=$(printf &#39;%%%02X&#39; &quot;&#39;$char&quot;) ;;\n    esac\n  done\n  echo &quot;$encoded&quot;\n}\n\n\n</code></pre></div>\n<p>테스트 결과를 읽고 슬랙으로 보내는것은 간단하나<br/>\n어떤 종목이 실패해서 어떻게 보이는 상태인지 한번에 알려면 <br/>실패 스크린샷도 보내는게 맞는것 같았다. (그게 자동화의 이유자나)<br/><br/>\n이를 위해 내가 이용한 slack api 는 3개다. (ㅠㅠ 한번에 보내는것도 만들어 줄 순 없었니)</p>\n<ul>\n<li><code class=\"language-text\">files.getUploadURLExternal</code> : 임시 파일 upload url 을 얻는다.</li>\n<li><code class=\"language-text\">files.completeUploadExternal</code> : 파일 업로드 시킴</li>\n<li><code class=\"language-text\">files.remote.share</code> : 슬랙방에 파일(스샷)공유<br/><br/>\nupload 라는 메소드를 이용하려 했지만 <br/>해당 메소드는 25년부터 지원하지 않는다 하여</li>\n</ul>\n<p><code class=\"language-text\">getUploadURLExternal</code>, <code class=\"language-text\">completeUploadExternal</code> 두개의 메소드를 사용하였다.\n슬랙방에 사진이 뜨기를 몇십번의 테스트를 진행하였고.<br/><br/><br/>\n드디어 !<br/><br/>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b7f343e7bd99af04bab24ef742408a3c/0d292/screenshot2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 67.08860759493672%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB2UlEQVQ4y5WTzWoTURiGcwHZSW2mM5nMnDl/MzWCrRb/qlKVCLEBA26CKHgDxYVduCleQKuhNmqRrrwJKYIiVqHooog7t7oqFDciIo/MtKkTNSEeeM83A/M+8/2cU7DWYoyhN+4+D6u8t5Bu/4L+j/Kewp+wJInR1qK1RimN0hptzN/Su7FvhqmklNSvzTFZreKUHOLkEDap4geSsi8oVyL8IKJcEbjlIIsDgZFUzN2a58psg2NTxzl5+gxSJ5TGfA6WPEZGXQ6MjOG4FQJhCCM9GJiWceFijcmpabSdQMjD3J6/w0rnEZ2Hq7SXV1hcus/1GzezbJVJsgFaa/ZiTw/Tnlg8P6LsS4JAUip5bLx5z+cv27RaLRYW7pKuJ2tPs2y1He8HtPvAtMRQKKSM8DyXZ+uv2Hi7RbFY5Oy5GbZ3fnCv/ZhRxxsOGKmYMNwDui7rz1+z+e4jrutSv9xg5+tP2surwwOFiqkEOoM6jseLl5tsffiEEIJm8yrfvsODzlo2pAHA35OKlEFIg4gMQaiZOV+jdqlOHI9zZOIos40mJ05NEwqJ0n3Podn/U16xtYRhQBBUMoNSCt/3iSJB19fr7Sm5e39tToY4jjN1j1aSJNl7/tt8yb8Arm6jHMgfOvEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"screenshot\"\n        title=\"screenshot\"\n        src=\"/static/b7f343e7bd99af04bab24ef742408a3c/f058b/screenshot2.png\"\n        srcset=\"/static/b7f343e7bd99af04bab24ef742408a3c/c26ae/screenshot2.png 158w,\n/static/b7f343e7bd99af04bab24ef742408a3c/6bdcf/screenshot2.png 315w,\n/static/b7f343e7bd99af04bab24ef742408a3c/f058b/screenshot2.png 630w,\n/static/b7f343e7bd99af04bab24ef742408a3c/40601/screenshot2.png 945w,\n/static/b7f343e7bd99af04bab24ef742408a3c/78612/screenshot2.png 1260w,\n/static/b7f343e7bd99af04bab24ef742408a3c/0d292/screenshot2.png 1620w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n<br/><br/></p>\n<h4>매일 아침마다 실행하도록 자동화하기</h4>\n<p><code class=\"language-text\">Crontab</code> : 크론탭(Crontab)은 Unix 계열 운영 체제에서 사용되는 시간 기반 잡 스케줄러이다. <br/><br/>\n크론탭을 사용 할 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">crontab -e\n</code></pre></div>\n<p>시간 설정해주고 실행할 파일 기재해준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">40 8 * * * /path/to/your/script.sh</code></pre></div>\n<p>작성한 쉘 스크립트는 오전 8시 40분 해당 테스트를 실행시켜 줄 것이다.</p>\n<p>매일 이슈가 있는 종목들이 한개 이상씩은 나온다.<br/>\n이러한 세팅이 앞으로 여러모로 쓸모가 있을것 같아 기분이 좋다.</p>","frontmatter":{"title":"매일 아침 신규상장건 E2E 테스트 하기 with slack api","date":"June 06, 2024","description":"매일 아침 cypress 자동 테스트 결과 slack 봇으로 실패 스크린샷 보내기"}},"previous":{"fields":{"slug":"/about-monorepo/"},"frontmatter":{"title":"모노레포의 효율성 (pnpm + turbo)"}},"next":null},"pageContext":{"id":"74e9c19f-a40d-5ff7-abf3-07ce11458ade","previousPostId":"af02d02e-8d50-5c07-b6f3-43b1c43cfb19","nextPostId":null}},"staticQueryHashes":["2841359383","3257411868"]}